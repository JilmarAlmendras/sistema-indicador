// src/lib/api/indicadoresApi.js
/* ================================================================
   ‚úÖ SOLUCI√ìN DEFINITIVA PARA MIXED CONTENT Y URLS
   ================================================================ */

// üîß CONFIGURACI√ìN FLEXIBLE DE ENTORNOS
const ENV_CONFIG = {
  development: {
    hostnames: ['localhost', '127.0.0.1'],
    backendUrl: 'http://localhost:8000',
    protocol: 'http'
  },
  production: {
    // üéØ FORZAR URL HTTPS HARDCODED COMO √öLTIMO RECURSO
    backendUrl: import.meta.env.VITE_API_URL || 
                process.env.VITE_API_URL ||
                'https://backend-indicadores-production.up.railway.app', // HARDCODED HTTPS
    protocol: 'https',
    enforceHttps: true
  }
};

// üîç DETECCI√ìN AUTOM√ÅTICA DE BACKEND URL
function detectBackendUrl() {
  const currentDomain = window.location.hostname;
  
  // üö® SOLUCI√ìN TEMPORAL: Forzar HTTPS siempre
  const baseBackendUrl = 'backend-indicadores-production.up.railway.app';
  const httpsUrl = `https://${baseBackendUrl}`;
  
  console.log('üîí [API] Forzando URL HTTPS del backend:', httpsUrl);
  
  // Lista de posibles URLs de backend (todas HTTPS)
  const possibleBackendUrls = [
    httpsUrl, // URL principal forzada a HTTPS
    'https://sistema-indicadores-backend-production.up.railway.app',
    'https://backend-sistema-indicadores-production.up.railway.app',
    
    // Solo para desarrollo local
    currentDomain.includes('localhost') ? 'http://localhost:8000' : null
  ].filter(Boolean);
  
  console.log('üîç [API] URLs de backend detectadas:', possibleBackendUrls);
  return possibleBackendUrls[0];
}

/* ================================================================
   üöÄ DETECCI√ìN INTELIGENTE DE ENTORNO
   ================================================================ */
function detectEnvironment() {
  const hostname = window.location.hostname;
  const protocol = window.location.protocol;
  
  // ‚úÖ Desarrollo local
  if (ENV_CONFIG.development.hostnames.includes(hostname)) {
    console.log('üîß [API] Entorno: DESARROLLO LOCAL');
    return {
      env: 'development',
      baseUrl: ENV_CONFIG.development.backendUrl,
      protocol: ENV_CONFIG.development.protocol
    };
  }
  
  // ‚úÖ Producci√≥n (Railway, Vercel, etc.)
  console.log('üöÄ [API] Entorno: PRODUCCI√ìN');
  console.log('üîç [API] VITE_API_URL:', import.meta.env.VITE_API_URL);
  console.log('üîç [API] process.env.VITE_API_URL:', process.env.VITE_API_URL);
  console.log('üîç [API] detectBackendUrl():', detectBackendUrl());
  
  let backendUrl = ENV_CONFIG.production.backendUrl.trim();
  console.log('üîç [API] backendUrl inicial:', backendUrl);
  
  // üö® FORZAR HTTPS SIEMPRE EN PRODUCCI√ìN
  if (!backendUrl.startsWith('https://')) {
    if (backendUrl.startsWith('http://')) {
      backendUrl = backendUrl.replace('http://', 'https://');
      console.log('üîí [API] Convertido HTTP‚ÜíHTTPS:', backendUrl);
    } else if (!/^https?:\/\//i.test(backendUrl)) {
      backendUrl = `https://${backendUrl}`;
      console.log('üîí [API] A√±adido protocolo HTTPS:', backendUrl);
    }
  }
  
  // üõ°Ô∏è VERIFICACI√ìN FINAL: Solo permitir HTTPS en producci√≥n
  if (!backendUrl.startsWith('https://')) {
    console.error('‚ùå [API] Backend URL no es HTTPS:', backendUrl);
    backendUrl = 'https://backend-indicadores-production.up.railway.app';
    console.log('üîí [API] Usando URL hardcoded segura:', backendUrl);
  }
  
  // Remover trailing slash y forzar HTTPS de nuevo
  backendUrl = backendUrl.replace(/\/+$/, '').replace('http://', 'https://');
  
  console.log('‚úÖ [API] URL final del backend:', backendUrl);
  
  return {
    env: 'production',
    baseUrl: backendUrl,
    protocol: 'https'
  };
}

// üåç Configuraci√≥n global
const API_CONFIG = detectEnvironment();
const BASE_URL = API_CONFIG.baseUrl;

console.log(`‚úÖ [API] Configuraci√≥n: ${BASE_URL}`);

/* ================================================================
   üõ°Ô∏è WRAPPER FETCH CON PROTECCI√ìN MIXED CONTENT
   ================================================================ */
async function secureApiCall(endpoint, options = {}) {
  let fullUrl = `${BASE_URL.replace('http://', 'https://')}${endpoint}`;
  
  // üõ°Ô∏è VERIFICACI√ìN CR√çTICA: Forzar HTTPS en producci√≥n
  if (window.location.protocol === 'https:') {
    if (fullUrl.startsWith('http://')) {
      fullUrl = fullUrl.replace('http://', 'https://');
      console.log('üîí [API] Mixed Content prevenci√≥n - Convertido a HTTPS:', fullUrl);
    } else if (!fullUrl.startsWith('https://')) {
      fullUrl = 'https://' + fullUrl;
      console.log('üîí [API] Mixed Content prevenci√≥n - A√±adido protocolo HTTPS:', fullUrl);
    }
  }
  
  // üö® VERIFICACI√ìN EXTRA: Asegurar que NUNCA usemos HTTP en producci√≥n
  if (fullUrl.startsWith('http://') && !fullUrl.includes('localhost')) {
    fullUrl = fullUrl.replace('http://', 'https://');
    console.error('üö® [API] CR√çTICO: Detectado HTTP en producci√≥n, forzando HTTPS:', fullUrl);
  }
  
  console.log(`üì° [API] Request: ${options.method || 'GET'} ${fullUrl}`);
  
  try {
    // ‚úÖ Configuraci√≥n de headers por defecto
    const defaultHeaders = {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      // üîí Headers de seguridad
      'X-Requested-With': 'XMLHttpRequest',
      'Cache-Control': 'no-cache'
    };
    
    // üîß Merge headers
    const finalHeaders = {
      ...defaultHeaders,
      ...(options.headers || {})
    };
    
    // üöÄ Ejecutar fetch primera vez
    let response;
    
    try {
      response = await fetch(fullUrl, {
        ...options,
        headers: finalHeaders,
        // ‚úÖ Configuraciones adicionales de seguridad
        mode: 'cors',
        credentials: 'omit', // No enviar cookies por defecto
        cache: 'no-cache'
      });
    } catch (fetchError) {
      // üõ°Ô∏è SI FALLA POR MIXED CONTENT, INTERCEPTAR Y REINTENTAR
      if (fetchError.message.includes('Mixed Content') || 
          fetchError.message.includes('insecure') ||
          fullUrl.includes('http://')) {
        
        console.log('üîí [API] Error Mixed Content detectado, forzando HTTPS...');
        const httpsUrl = fullUrl.replace('http://', 'https://');
        console.log(`üîí [API] Reintentando con: ${httpsUrl}`);
        
        response = await fetch(httpsUrl, {
          ...options,
          headers: finalHeaders,
          mode: 'cors',
          credentials: 'omit',
          cache: 'no-cache'
        });
      } else {
        throw fetchError;
      }
    }
    
    // üö® VERIFICACI√ìN CR√çTICA: Mixed Content
    if (window.location.protocol === 'https:' && response.url.startsWith('http://')) {
      const mixedContentError = `‚ùå MIXED CONTENT DETECTADO: 
      - P√°gina: ${window.location.protocol}//${window.location.host}
      - API: ${response.url}
      - Soluci√≥n: Configurar VITE_API_URL con HTTPS`;
      
      console.error(mixedContentError);
      throw new Error('Mixed Content: La API debe usar HTTPS cuando el frontend usa HTTPS');
    }
    
    // ‚úÖ Verificar respuesta HTTP
    if (!response.ok) {
      let errorBody;
      const contentType = response.headers.get('content-type');
      
      try {
        if (contentType && contentType.includes('application/json')) {
          errorBody = await response.json();
        } else {
          errorBody = await response.text();
        }
      } catch (parseError) {
        errorBody = `Error ${response.status}: ${response.statusText}`;
      }
      
      console.error(`‚ùå [API] Error ${response.status}:`, errorBody);
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorBody)}`);
    }
    
    // ‚úÖ Procesar respuesta exitosa
    const contentType = response.headers.get('content-type');
    let data;
    
    if (contentType && contentType.includes('application/json')) {
      data = await response.json();
    } else {
      data = await response.text();
    }
    
    console.log(`‚úÖ [API] Success: ${options.method || 'GET'} ${endpoint}`);
    return { data, response };
    
  } catch (error) {
    // üö® Manejo de errores robusto
    console.error(`‚ùå [API] Error en ${endpoint}:`, error);
    
    // Errores espec√≠ficos para mejor debugging
    if (error.message.includes('Mixed Content')) {
      throw new Error(`üîí Mixed Content: Verifica que VITE_API_URL use HTTPS en producci√≥n`);
    }
    
    if (error.message.includes('CORS')) {
      throw new Error(`üåê CORS Error: El backend debe permitir el origen ${window.location.origin}`);
    }
    
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      throw new Error(`üåê Network Error: No se puede conectar con ${BASE_URL}`);
    }
    
    throw error;
  }
}

/* ================================================================
   üìã API ENDPOINTS - SISTEMA DE INDICADORES
   ================================================================ */
export const indicadoresApi = {
  // üìä GET /api/indicadores - Obtener todos los indicadores
  getIndicadores: async () => {
    const result = await secureApiCall('/api/indicadores');
    return result.data;
  },

  // üè¢ GET /api/indicadores/area/:area - Indicadores por √°rea
  getIndicadoresByArea: async (area) => {
    const encodedArea = encodeURIComponent(area);
    const result = await secureApiCall(`/api/indicadores/area/${encodedArea}`);
    return result.data;
  },

  // üîç GET /api/indicadores/:id - Indicador espec√≠fico
  getIndicador: async (id) => {
    const result = await secureApiCall(`/api/indicadores/${id}`);
    return result.data;
  },

  // ‚ûï POST /api/indicadores - Crear indicador
  createIndicador: async (data) => {
    const result = await secureApiCall('/api/indicadores', {
      method: 'POST',
      body: JSON.stringify(data)
    });
    return result.data;
  },

  // ‚úèÔ∏è PUT /api/indicadores/:id - Actualizar indicador
  updateIndicador: async (id, data) => {
    const result = await secureApiCall(`/api/indicadores/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data)
    });
    return result.data;
  },

  // üóëÔ∏è DELETE /api/indicadores/:id - Eliminar indicador
  deleteIndicador: async (id) => {
    const result = await secureApiCall(`/api/indicadores/${id}`, {
      method: 'DELETE'
    });
    return result.data;
  },

  // üìà GET /api/indicadores/estadisticas/dashboard - Estad√≠sticas
  getEstadisticas: async () => {
    const result = await secureApiCall('/api/indicadores/estadisticas/dashboard');
    return result.data;
  },

  // üîç GET /health - Health check del backend
  healthCheck: async () => {
    const result = await secureApiCall('/health');
    return result.data;
  },

  // üß™ GET /test-cors - Test de CORS
  testCors: async () => {
    const result = await secureApiCall('/test-cors');
    return result.data;
  }
};

/* ================================================================
   üõ†Ô∏è UTILIDADES ADICIONALES
   ================================================================ */

// üîß Debug: Obtener configuraci√≥n actual
export const getApiConfig = () => ({
  environment: API_CONFIG.env,
  baseUrl: BASE_URL,
  protocol: API_CONFIG.protocol,
  currentPage: `${window.location.protocol}//${window.location.host}`,
  timestamp: new Date().toISOString()
});

// üß™ Test de conectividad
export const testConnection = async () => {
  try {
    console.log('üß™ [API] Probando conectividad...');
    const health = await indicadoresApi.healthCheck();
    console.log('‚úÖ [API] Conectividad OK:', health);
    return { success: true, data: health };
  } catch (error) {
    console.error('‚ùå [API] Error de conectividad:', error);
    return { success: false, error: error.message };
  }
};

// Export por defecto
export default indicadoresApi;
